{"_id":"37ea80db-2310-38ed-bca3-1e1ed36b6213","authorName":"Scott McKay","authorEmailEncrypted":"JewP06HkrXSSagGuTrSvE1c7PFB1AFggmSlO461a8Gkw0m6I2VZjK/spAOzntuMWN4wletZ3ZucaYh+0CyuEhCjhYd/k2DejaVAy3z74Owtqz47YrWmfkX91XwxiWmKDEOMWEDDhiZKblPtoi8gE/wk620CNlvUrQXzYOyKt+4hIfHyQ6y064dLvlaBhhdViYcWzve5w3FHEpR8Xsn2anhI+eEBZeopzGGL+quMvRHOWq76PzfztJ7UCAMpRiwNfyXPMWP/u9PH9r51ifeA7tVbn/D5ll4Y/1NmxQhHUu1HPm/SKdeUOBbUqZpL8Yj0waGy4s3+ikCTDUuq6dqvl38O8lbPIECOSv9PRqfLd7fZtPlampc23O3cYx8mJSHIFqmgSMU4GLSImDN78dHUZSCrd/Fr+xlakShH5lcNtVtPr9+4h7RMWoeS3XMkOAjbmPun+1Rj+NM8PW01pYGy+GDWqV1MwnrJcLsrkcbKtuhPZL4KHW0vRKP6vagVTyhUyGtoTiFGWHUYUwo+oZriJEOu8fnOozMP0L46IbL/zw+dTVMU2SgoRMW/j5ovyMES29GElorffDubt08Z5mXgeb0zw4p9b98YVPDKFXPHTguzOXvMVmnzT9Wi95VOlC1651wauXoDTU95usAO9jDT+67fhufD6NuVj+v09+RIwHsk=","authorEmailMD5":"384d2327b00c037623207507e3a14cc7","message":"It's a low latency service. Letting them run synchronously costs me over 1ms per item in the batch. By firing off the subrequests on separate threads I can complete an entire batch of 50 requests, including a call to an external system, in 10ms total. If I didn't care about the latency I would definitely let it do its own thing. Obviously there's a cost in running more threads though to balance out.\r\n\r\nI'm using QBWI to fire off the subrequests essentially as completely separate requests (an OData batch is just a way to pass multiple standalone requests at once). I wrap that in a TaskCompletionSource so that they're not fire-and-forget, and use Task.WhenAll to await the subrequests completing. I could equally use Task.Run for that, but I thought QBWI was more standard for ASP.NET. I would prefer a bit more control over how many threads were potentially used to process the batch, but I'm avoiding adding that complexity for the moment unless I need it.\r\n\r\nWhilst I run all the subrequests as separate requests, I attach a helper class with the AsyncBarrier to the request properties. When all the subrequests meet the barrier, I combine their info so it's just one call to the external system. I run the subrequests as standalone requests because I need the WebApi OData processing of the request input and formatting of response output that happens when I push them through the non-batch route.\r\n\r\nObviously this is very specific usage in a low latency environment and brings in a few of different considerations.","postId":"2013_10_taskrun-etiquette-and-proper-usage-fe7a94d6-0c34-3e54-ab2d-97969a27b041","replyTo":"1d9750d7-a733-3c8e-8639-c02c3baa6c08","date":"2017-11-29T21:45:55Z","timestamp":1511991955,"authorUserId":"disqus:disqus_U6noZg42Is"}