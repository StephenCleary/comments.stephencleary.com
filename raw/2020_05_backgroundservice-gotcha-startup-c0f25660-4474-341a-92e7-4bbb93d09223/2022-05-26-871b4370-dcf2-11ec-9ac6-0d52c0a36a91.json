{"_id":"871b4370-dcf2-11ec-9ac6-0d52c0a36a91","postId":"2020_05_backgroundservice-gotcha-startup-c0f25660-4474-341a-92e7-4bbb93d09223","postUri":"https://blog.stephencleary.com/2020/05/backgroundservice-gotcha-startup.html","replyTo":"2e2000b0-dcea-11ec-beea-6b98b825127f","authorEmailEncrypted":"MFxedk1g5SWTCapcOOsU6uDS49HMbLs9h1xmUiUSHadFTcdt3T2C/gXpOtd8cYtQk7xtmelp13wPUA5PyjvvRaCJ/Sk0cE+G7PmpCP4jHfKWA4POoCzw/3lxlh6daKzlL9JWg+Qbm9f3hpQxCG48JKLM/w/pDvBCQ0qkPq776YPXz+D1aFo1KEpI2UTp4WsRuBeBVpDnXdjMCilV1bzVry6Xe2wCFbFHKA8G9YQ/xI9jwznUqhUT3kRO1bcH8pnNrM3d8mjctSJ+P+W6SfCt4yjaDaVfoOMWnVk/slFHH0ahiXeGoCuEXHXLruhJCwumT8DyfrJN1le3oGArnHwjyW1FGhoiegtKLqwhfRoT4QJpuFcYXs73MxsK2GXB0fax33ygyB2AzxkUkFD0XoIrMGHj1iOhQnYAz6Xy+hTJfZej63Kv6HW/zYDbETwnhh/nUTSMFDALm0bOlSpByXMb0KwJ5sJhHs33d+wAGIc3ZtdohNW9uPbb7MARFX4VjRbj2LpCV7VI8TeY5t7MmXQL7zPtgO2CTXXRhSFA+AeOsvSN6zQhlzoGxb8L0LIPO23PGznADYXRwq/OVaVKWOoabPf0fVSbIKVFsPsJXhzqkx+/ap/0QNlhiTgRdSTYJ5EEGlv+0XxYoohoitzJdZRJFi/lDlsqxf6hYANLvARQJsY=","authorEmailMD5":"c5a82c9d49550abe8703272ef858cb18","authorName":"Eric Lynch","authorUri":"","message":"Final correction.  Boy, I do apologize!\r\n\r\nBoth \"Task.Run\" and \"await Task.Yield()\" were producing similar results, solving half of my problem.  The unpredictability of log message order (from ILogger) was not helping me diagnose and solve the issue.\r\n\r\nUltimately, I had to do the following to solve my whole problem...\r\n\r\nIn my constructor...\r\nCreate a TaskCompletionSource.\r\nUse \"IHostApplicationLifetime.ApplicationStarted.Register\" to register a method that sets the result for the TaskCompletionSource (when the application truly starts).\r\n\r\nIn my ExecuteAsync...\r\n\"await\" the completion of the TaskCompletionSource.\r\n\"await Task.Yield()\" so that the \"gotcha\" in BackgroundService doesn't block the application from starting.\r\n\r\nPrevious approaches failed after about a half-dozen iterations.  After hundreds of iterations, using the new approach, and checking the boolean that backs my TaskCompletionSource (instead of my unreliable application log), I am now confident that this \"magic\" recipe works.\r\n\r\nThis was so much fun I wonder if it wouldn't have been easier to simply roll my own BackgroundService! \r\n\r\nAnyhow, thanks again for the advice of others on this thread, it was invaluable in solving many of the issues I encountered.","date":"2022-05-26T12:51:15.093Z"}