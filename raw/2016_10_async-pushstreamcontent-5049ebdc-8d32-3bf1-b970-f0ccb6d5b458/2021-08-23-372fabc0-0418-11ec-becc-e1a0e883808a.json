{"_id":"372fabc0-0418-11ec-becc-e1a0e883808a","postId":"2016_10_async-pushstreamcontent-5049ebdc-8d32-3bf1-b970-f0ccb6d5b458","postUri":"https://blog.stephencleary.com/2016/10/async-pushstreamcontent.html","replyTo":"","authorEmailEncrypted":"dHHsR56aRVt1ChuIWZrr2wQEPN7+Q05qvg9RxoTX1PZMVF8oSJioVKD+NM/tZewTkLB6HJROk/PDW/Kl5NSYBvxL+CFA125kYrmh4fGKN4cs5z+ZomWvOGd4yXaQ89MlgGdGhX/x96iGnZlnBCvi0pylRYHUeakyArfshb4w8kCYwTERnuepgvf5DDOtKZJBCSFvMBug0DPPE5fqrDHl/xnfCRNwWlfXWuT5ZUB2QUgNWwpUTikPIcsdheLYvaj/5aRvGqdQd+32106Fbq7JTQt4GGqwxYZTxRDSj2ZS/0c0pEUVxNAr+5Yg81DccpgmNmpU8tdVpSlaDc3sgQElBKBPwVW0GfPR/fcSuf/ugcCjJiL70jWk99fm0hLMgOr2Fan0SmwSkEKniB4GWpGUkVRGSXp5uJr/V/p15bhuE/vEXKdaTeDp2x0LyG8zSXtV9Tbm5/7WNxnDB/yovlIdg50ePXyoIpz4Ir/4NU7ArfFx2aN+o3R6NzLxEMIeKyLQEWUGkuxfN6lI7oRMDMiqQDLAsEPBQdaUFM9EcNqlh6msbDj1p0X0CkmGGeThePmWMWT2ql33o/Ev1Ootp8Jjo92uP1s8MSesWnC+EbHjmpPhDTqgfTRfX7PYYnQHYLAwAi1Q5pVVb8ADrcdrMfSzqL84CsI1BCkw1INj9n+af+M=","authorEmailMD5":"768bf9cb2a12b3d3f90c29007a99fe57","authorName":"finarne","authorUri":"","message":"Hi Stephen,\r\n\r\nI have a scenario where I am downloading a single file by calling an external API, but rather than my API return the content to the caller, the API will upload the content to a DataLake folder using the UploadStreamAsync method.\r\n\r\nhttps://docs.microsoft.com/en-us/dotnet/api/azure.storage.files.datalake.datalakefileclient.uploadasync?view=azure-dotnet#Azure_Storage_Files_DataLake_DataLakeFileClient_UploadAsync_System_IO_Stream_\r\n\r\nMy code is contained in an Azure Function, the main part of the body of the function\r\n\r\nSomething along the lines of:\r\n\r\nDataLakeFileClient theDataLakeClient = \"get instance of file client on correct datalake folder & file\";\r\nHttpClient httpClient = \"get instance of httpclient\";\r\nstring externalAPIEndpointToCallToGetFileAsStream = \"endpoint\";\r\n\r\nawait theDataLakeClient.UploadAsync(await httpClient.GetStreamAsync(externalAPIEndpointToCallToGetFileAsStream));\r\n\r\nThis is a simple hack that \"works\" but I suspect that the code is downloading the entire file in the GetStreamAsync method before it then passes the stream to UploadAsync method.\r\n\r\nMy scenario has cases where the files to download can run into the 100s of MB and so the memory pressure on the Function host seems to baloon.\r\n\r\nShould I be looking to pass a parameter to the UploadAsync method in a different way?\r\n\r\nShould I perhaps pass as a parameter another method that returns an async stream, and in that method use some of the techniques you demoed on this talk: https://www.youtube.com/watch?v=Ylcl8hKks_Y to \"move\" the bytes from the downloading stream to the uploading stream?","date":"2021-08-23T13:44:19.519Z"}